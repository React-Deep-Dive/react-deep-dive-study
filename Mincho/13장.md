# 모리딥 13장

# 웹페이지의 성능을 측정하는 다양한 방법

## 애플리케이션에서 확인하기

1. create-react-app

cra로 리액트 앱을 생성했다면 reportWebVitals에서 CLS, FID, FCP, LCP, TTFB를 측정하는 함수가 작성되어 있다.

이러한 자바스크립트 수준의 라이브러리가 브라우저의 웹페이지 성능을 측정할 수 있는 이유는 performanceObserver라는 웹 API를 사용하고 있기 때문이다.

1. create-next-app

Next.js에서도 비슷한 방식으로 사용해 볼 수 있다. next에서는 NextWebVitalsMetric을 제공한다. 앞에서 언급한 핵심 웹 지표 이외에도 Next.js에 특화된 사용자 지표도 제공한다.

- Next.js-hydration : 페이지가 서버 사이드에서 렌더링되어 하이드레이션하는 데 걸린 시간
- Next.js-route-change-to-render : 페이지가 경로를 변경한 후 페이지를 렌더링을 시작하는 데 걸리는 시간
- Next.js-render : 경로 변경이 완료된 후 페이지를 렌더링하는데 걸린 시간

위의 지표는 사실 구글에서 제공하는 핵심 웹 지표와는 다르게 어느 정도 이하로 지표가 기록돼야 한다는 기준은 없다!

## 구글 라이트하우스

애플리케이션에서 제공하는 지표 수집 방식은 단순히 코드 몇 줄만으로 지표를 수집할 수 있다는 장점이 있지만 기존 애플리케이션 코드의 수정이 필요하다는 점과 더불어 사전 준비가 필요하다.

이에 반해 코드 수정이나 배포, 수집 없이도 지표를 확인할 수 있는 방법이 있다. → `구글 라이트하우스`

여기서는 크롬 개발자 도구를 이용해 라이트하우스를 실행하였다. 크롬 개발자 도구를 열어 lighthouse탭을 클릭하면 수집을 진행할 수 있다. 참고로 크롬에 설치된 다른 확장 프로그램 등이 영향을 줄 수 있으므로 가급적 시크릿 창으로 실행해 확인하는 것을 권장한다.

### 탐색 모두

일반적으로 페이지에 접속했을 때부터 로딩이 완료될 때까지의 성능을 측정하는 모드다. 페이지를 처음부터 불러와 페이지 로딩이 끝날 때까지 지표를 수집한다.

![스크린샷 2024-04-01 오후 4.25.34.png](https://prod-files-secure.s3.us-west-2.amazonaws.com/f67f7c5d-2ebc-471c-9cba-9ca978e99548/cfd65675-a9a9-4b45-b332-2a742a1f31b4/%E1%84%89%E1%85%B3%E1%84%8F%E1%85%B3%E1%84%85%E1%85%B5%E1%86%AB%E1%84%89%E1%85%A3%E1%86%BA_2024-04-01_%E1%84%8B%E1%85%A9%E1%84%92%E1%85%AE_4.25.34.png)

지표 수집이 완료되면 다음과 같은 리포트가 생성된 것을 볼 수 있다.

- 성능
  성능은 웹페이지의 성능과 관련된 지표를 확인할 수 있는 영역이다.
  핵심 웹 지표인 FCP, LCP, CLS외에도 3가지 추가적인 지표가 있다. - time to interactive : 페이지에서 사용자가 완전히 상호작용할 수 있을 때까지 걸리는 시간
  3.8초 이내면 좋음, 7.3초 이내면 보통, 그 이후는 개선이 필요한 것을 본다. 최대한 빠르게 상호작용이 되도록 준비하려면 메인 스레드가 하는 자바스크립트 작업을 최소화해야 한다. - speed Index : 페이지가 로드되는 동안 콘텐츠가 얼마나 빠르게 시각적으로 표시되는지를 계산한다. 3.4초 이내면 좋음, 5.8초 이내면 보통, 그 이후는 느리다고 판단한다. - Total Blocking Time : 메인 스레드에서 특정 시간 이상 실행되는 작업이다. 메인 스레드에서 작업이 50ms이상 걸리면 이를 긴 작업이라고 간주하고, 이런 시간을 모아서 total Blocking Time이라 한다.
- 접근성
  장애인 및 고령자 등 신체적으로 불편한 사람들이 일반적인 사용자와 동등하게 웹페이즈를 이용할 수 있도록 보장하는 것을 말한다.
- 권장사항
  웹사이트를 개발할 때 고려해야 할 요소들을 얼마나 지키고 있는지 확인할 수 있다.
  여기서 말하는 권장사항에는 보안, 표준 모드, 최신 라이브러리, 소스 맵 등 다양한 요소들이 포함되어 있다. - CSP가 XSS 공격에 효과적인지 확인 : XSS란 Cross Site Scripting의 약자로, 개발자가 아닌 제3자가 삽입한 스크립트를 통해 공격하는 기법이다. CSP란 Content Security Policy의 약자로, 웹 사이트에서 호출할 수 있는 컨텐츠를 제한하는 정책이다. - HTTPS 사용 : ssl인증으로 보안적 요소를 확인한다. - 이미지를 올바른 가로세로 비율로 표시 : 이미지의 실제 크기와 표시되는 크기 사이의 비율이 일치하는지 확인한다. - 콘솔에 로그된 브라우저 오류 없음 : 콘솔에 에러가 기록되는 것은 사용자에게 영향을 미치지 않을 수도 있지만 분명 웹페이제 문제가 있다는 사실이다. - 페이지에 유효한 소스 맵이 있음 : 소스 맵은 압축되어서 읽기 어려워진 소스코드를 원본 소스코드로 변환할 수 있도록 도와주는 파일이다.
- 검색 엔진 최적화
  구글과 같은 검색엔지이 쉽게 웹페이지 정보를 가져가서 공개할 수 있도록 최적화 돼 있는지를 확인한다.

## WebPageTest

웹사이트 성능을 분석하는 도구로 가장 널리 알려진 도구다. 무료로 제공되는 기능만으로도 웹사이트 성능과 로딩 과정에서 일어나는 일을 분석하는 데 충분하다.

- Site Performance : 웹 사이트의 성능을 분석을 위한 도구
- Core Web Vitals : 웹 사이트의 핵심 웹 지표를 확인하기 위한 도구
- Lighthouse : 구글 라이트하우스 도구
- Visual Comparison : 2개 이상의 사이트를 동시에 실행해 시간의 흐름에 따른 로딩 과정 비교하는 도구
- Traceroute : 네트워크 경로를 확인하는 도구

기본적으로 WebPageTest는 미국, 인도, 캐나다, 독일 등 한국과 어느 정도 거리가 먼 서버를 기준으로 테스트하기 때문에 크롬 개발자 도구에서 테스트했을 때보다 성능 지표가 좋지 않을 가능성이 매우 높다.

[https://www.webpagetest.org/](https://www.webpagetest.org/에) 에 접속한 다음, Site Performance를 선택한 뒤 분석을 원하는 웹사이트 주소를 입력하고 테스트를 시작한다.

WebPageTest의 성능 테스트는 총 3번 이뤄지기 때문에 3개의 서로 다른 결과를 확인 할 수 있다. 측정 결과 페이지는 크게 세가지 영역으로 나눠져 있다.

- Opportunities & Experiments
  웹 사이트에 대한 평가를 총 3가지로 나눠 보여준다. - Is it Quick : 웹사이트가 충분히 빠른지를 평가한다. 빠름을 나타내는 것은 TTFB가 짧은지, LCP시간이 합리적인지 이다. - Is it Usable : 웹사이트의 사용성과 시각적인 요소를 확인한다. CLS를 최소화하는지, 상호작용을 빠르게 할 수 있는지 등이다. - Is it Resislient : 보안 취약성을 점검한다.
- Observed Metrics : 최초 바이트까지의 시간, 렌더링 시작에 소요되는 시간, 최초 콘텐츠풀 페인트 등 측정할 수 있는 지표를 제공한다.’
- Individual Runs : 기본적으로 WebPageTest는 3번의 테스트를 돌려 평균값을 보여주는데, 각 실행별로 어떠한 결과를 보여주는지 확인할 수 있다.

### Opportunities & Experiments

각 요소별로 필자가 관심있었던 상세 지표만 나열해 봣다.

- 주요 영역 내에 게으른 로딩되는 이미지가 있는지 확인한다. 이미지에 대한 게으른 로딩이 항상 좋은 것은 아니다. 사용자에게 보여지는 영역에 있는 이미지는 빠르게 로딩되는 것이 좋다.
- 문자의 노출을 지연시키는 커스텀 폰트가 있는지 확인한다. 만약 font-display=block과 같은 형식으로 폰트를 불러온다면 폰트가 로딩될 때까지 문자가 안보인다.
- 실제로 사용하지 않는 리소스를 rel=preload로 불러오지 않는지 확인한다. preload는 브라우저의 최우선 리소스로 지정되기 때문에 꼭 필요한 리소스에만 사용하는 것이 좋다.
- `최초로 다운로드받은 HTML과 최종 결과물 HTML사이에 크기 차이가 작아야 한다.(SPA에서 문제가 된다? 서버사이드 렌더링에서 더 문제가 되는게 아니라?)`
- 이미지 비율 부재로 인한 레이아웃 이동 가능성 여부를 확인한다. CLS때문…

### Filmstrip

웹사이트를 마치 필름을 보는 것처럼 시간의 흐름에 따라 어떻게 웹사이트가 그려졌는지, 또 어떤 리소스가 불러와졌는지 볼 수 있는 메뉴다. Filmstrip 메뉴를 활용하면 렌더링을 가로막는 리소스나 예상보다 일찍 실행되는 스크립트 등을 확인할 수 있다.

![스크린샷 2024-04-01 오후 4.57.40.png](https://prod-files-secure.s3.us-west-2.amazonaws.com/f67f7c5d-2ebc-471c-9cba-9ca978e99548/15dfe503-8f89-40ee-b3a0-608ce60e70fb/%E1%84%89%E1%85%B3%E1%84%8F%E1%85%B3%E1%84%85%E1%85%B5%E1%86%AB%E1%84%89%E1%85%A3%E1%86%BA_2024-04-01_%E1%84%8B%E1%85%A9%E1%84%92%E1%85%AE_4.57.40.png)

실제로 위의 사진에 나열된 리소스 중 주황색 X표시가 있는 것은 렌더링을 브로킹하는 리소스라는 뜻이다. 현재 결과에는 총 5개가 있으며, 아마 async나 defer로 불러오지 않는 script일 가능성이 크다.

HTML리소스는 1번으로, 1번의 크기가 매우 작은 것을 확인할 수 있다. 그리고 가운데 녹색 세로선은 최초 콘텐츠풀 페인트를 의미한다. 11번 리소스의 실행이 다 끝난 후에야 유의미한 렌더링이 시작됐음을 알 수 있다.(16초 파란 선이 렌더링이 끝난 지점이다.)

![스크린샷 2024-04-01 오후 5.02.43.png](https://prod-files-secure.s3.us-west-2.amazonaws.com/f67f7c5d-2ebc-471c-9cba-9ca978e99548/151964dd-432e-4502-92cf-3a191f4b1a60/%E1%84%89%E1%85%B3%E1%84%8F%E1%85%B3%E1%84%85%E1%85%B5%E1%86%AB%E1%84%89%E1%85%A3%E1%86%BA_2024-04-01_%E1%84%8B%E1%85%A9%E1%84%92%E1%85%AE_5.02.43.png)

16번부터 24번까지는 모두 svg파일인데 크기는 작으나 개별 요청 건으로 수행되고 있어 요청 수가 많다. 요청의 개수를 줄여 페이지를 빠르게 로딩할 수 있다.

![스크린샷 2024-04-01 오후 5.03.11.png](https://prod-files-secure.s3.us-west-2.amazonaws.com/f67f7c5d-2ebc-471c-9cba-9ca978e99548/337c3892-3546-42ce-9d0d-9ce443e2b16d/%E1%84%89%E1%85%B3%E1%84%8F%E1%85%B3%E1%84%85%E1%85%B5%E1%86%AB%E1%84%89%E1%85%A3%E1%86%BA_2024-04-01_%E1%84%8B%E1%85%A9%E1%84%92%E1%85%AE_5.03.11.png)

또한 65번은 사진을 가져오며 이 이미지는 background-image로 선언돼 있어 우선순위가 낮게 측정되어 LCP지표에 악영향을 준다. 이에 Image태그를 사용하는 것이 현명하다.

## 크롬 개발자 도구

web-vitals 라이브러리와 구글 라이트하우스 지표를 보고 나면 어떤 것이 문제고 무엇을 수정해야 할지 감이 올 것이다. 하지만 레거시한 코드의 경우 정확한 문제가 짐작이 되지 않을 수 있고 이를 더 자세히 들여다 볼 필요가 있다. 이를 위한 도구가 크롬 개발자 도구다.

크롬 개발자 도구를 활용하기 위해서는 시크릿 창으로 웹사이트를 여는 것이 좋다.

### 성능 통계

크롬 개발자 도구의 `Performance Insights`는 웹사이트의 성능을 자세하게 확인할 수 있는 도구다. 라이트하우스와 비슷하게 Page Load를 선택해 웹사이트 로딩 시작부터 끝까지 확인하거나, Start Recording을 눌러 원하는 액션을 수행하면서 성능을 측정할 수 있다.

한 가지 눈에 띄는 것은 Throttling인데, 이는 고의로 네트워크와 CPU속도를 지연시키는 기능이다. 이러한 방식으로 열악한 환경의 유저의 기기를 예상해서 측정 가능하다.

또한 사용자에게 보이는 뷰포트를 생각해서 측정되기 때문에, 뷰포트 틀을 딱 잡고 측정하는 것이 현명하다.

- Insights
  Insights에서는 성능을 측정하는 기간 동안 발생한 이벤트 중 눈여겨봐야 할 내용을 시간의 흐름에 따라 모아서 보여준다. - 핵심 웹 지표 : FCP, LCP 등등 - Performance Measure : User Timing API로 측정한 지표들을 확인할 수 있다. Next.js로 제작된 애플리케이션이라면 이 API를 사용한 흔적을 볼 수 있다. - Long Task : Performance Insight에서 가장 주목해야할 지표이다. 메인 스레드에서 실행되는 데 오랜 시간으로 분류된 긴 작업을 의미한다.
  Long Task를 선택하면 어떤 함수로 인해 오랜 시간이 걸렸는지 확인할 수 있다. - Render blocking CSS : 렌더링을 막는 CSS라는 뜻이다.

          ![스크린샷 2024-04-03 오후 2.23.45.png](https://prod-files-secure.s3.us-west-2.amazonaws.com/f67f7c5d-2ebc-471c-9cba-9ca978e99548/d4594832-2204-4e36-bf75-7e9d1941baa3/%E1%84%89%E1%85%B3%E1%84%8F%E1%85%B3%E1%84%85%E1%85%B5%E1%86%AB%E1%84%89%E1%85%A3%E1%86%BA_2024-04-03_%E1%84%8B%E1%85%A9%E1%84%92%E1%85%AE_2.23.45.png)

          이러한 경우 조치할 수 있는 방안은 크게 3가지인데

          중요하지 않은 스타일이라면 스타일을 비동기적으로 요청하기

          미디어 쿼리를 활용해 디바이스에 필요한 스타일만 불러오기

          CSS 내부의 띄어쓰기, 줄바꿈 등을 압축해 크기를 줄이기

      - Forced Style recalculation : 이미 스타일이 한번 계산된 이후에 어떠한 이유로 스타일이 다시금 계산되는 작업이 발생했음을 의미한다.

- 메인 메뉴
  성능을 측정하는 기간 동안 무슨 일이 일어나는지 확인할 수 있는 다양한 기능을 제공한다.
  시간의 흐름에 따라 화면이 얼마나 그려졌는지 점검하면서 원하는 대로 페이지가 렌더링됐는지 점검할 수 있다. - Layout shift를 발생시키는 것을 언제 어떤 스크립트때문인지 확인이 가능하다. - 네트워크 요청도 시간의 흐름에 따라 파악할 수 있다. - Rendere에서는 렌더러가 어떤 작업을 하는지 확인이 가능하다.

### 성능

성능 탭은 Performance Insights탭이 등장하기 전부터 존재했으며, Performance Insights 탭에 비해 다소 내용이 어렵고 복잡하지만 그만큼 자세한 정보를 제공한다. 다만 Perfomance Insights의 정보만으로도 충분하므로 더 자세하게 알고 싶은 경우에 참고하면 좋다.
